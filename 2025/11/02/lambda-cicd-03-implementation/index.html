<!doctype html>
<html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="theme-color" content="#2c3e50"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="default"><title>Lambda CI/CD アーキテクチャ - 3. 実装ガイドライン - Tamamu blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#2c3e50"><meta name="application-name" content="Tamamu Blog"><meta name="msapplication-TileImage" content="/images/favicon.ico"><meta name="msapplication-TileColor" content="#2c3e50"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Tamamu Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="32x32" href="/images/favicon.ico"><meta name="description" content="ドキュメント構成 1. CI&amp;#x2F;CD環境構築における方針 2. 具体的な構成要素と役割 → 3. 各構成要素の実装に関する留意点 4. メリットとデメリットとして認識すべきこと  目次 Terraform実装ガイドライン SAM実装ガイドライン GitHub Actions実装ガイドライン 命名規則とタグ戦略 セキュリティ考慮事項 監視とロギング   Terraform実装ガイドライン"><meta property="og:type" content="blog"><meta property="og:title" content="Lambda CI/CD アーキテクチャ - 3. 実装ガイドライン"><meta property="og:url" content="https://blog.tamamu.cc/2025/11/02/lambda-cicd-03-implementation/"><meta property="og:site_name" content="Tamamu Blog"><meta property="og:description" content="ドキュメント構成 1. CI&amp;#x2F;CD環境構築における方針 2. 具体的な構成要素と役割 → 3. 各構成要素の実装に関する留意点 4. メリットとデメリットとして認識すべきこと  目次 Terraform実装ガイドライン SAM実装ガイドライン GitHub Actions実装ガイドライン 命名規則とタグ戦略 セキュリティ考慮事項 監視とロギング   Terraform実装ガイドライン"><meta property="og:locale" content="ja_JP"><meta property="og:image" content="https://blog.tamamu.cc/images/twcard.jpeg"><meta property="article:published_time" content="2025-11-02T13:03:00.000Z"><meta property="article:modified_time" content="2025-11-02T15:07:01.130Z"><meta property="article:author" content="ktamamu"><meta property="article:tag" content="AWS Lambda"><meta property="article:tag" content="CI/CD"><meta property="article:tag" content="Terraform"><meta property="article:tag" content="SAM"><meta property="article:tag" content="GitHub Actions"><meta property="article:tag" content="アーキテクチャ"><meta property="article:tag" content="インフラ"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:image:src" content="https://blog.tamamu.cc/images/twcard.jpeg"><meta property="twitter:creator" content="@ktamamu"><meta property="twitter:site" content="@ktamamu"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.tamamu.cc/2025/11/02/lambda-cicd-03-implementation/"},"headline":"Lambda CI/CD アーキテクチャ - 3. 実装ガイドライン","image":[],"datePublished":"2025-11-02T13:03:00.000Z","dateModified":"2025-11-02T15:07:01.130Z","author":{"@type":"Person","name":"ktamamu"},"publisher":{"@type":"Organization","name":"Tamamu blog","logo":{"@type":"ImageObject","url":null}},"description":"ドキュメント構成 1. CI&#x2F;CD環境構築における方針 2. 具体的な構成要素と役割 → 3. 各構成要素の実装に関する留意点 4. メリットとデメリットとして認識すべきこと  目次 Terraform実装ガイドライン SAM実装ガイドライン GitHub Actions実装ガイドライン 命名規則とタグ戦略 セキュリティ考慮事項 監視とロギング   Terraform実装ガイドライン"}</script><link rel="canonical" href="https://blog.tamamu.cc/2025/11/02/lambda-cicd-03-implementation/"><link rel="alternate" href="/atom.xml" title="Tamamu blog" type="application/atom+xml"><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">Tamamu blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="カタログ" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="検索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2025-11-02T13:03:00.000Z" title="11/2/2025, 10:03:00 PM">2025-11-02</time>に投稿</span><span class="level-item"><time dateTime="2025-11-02T15:07:01.130Z" title="11/3/2025, 12:07:01 AM">2025-11-03</time>に更新</span><span class="level-item"><a class="link-muted" href="/categories/AWS/">AWS</a><span> / </span><a class="link-muted" href="/categories/AWS/DevOps/">DevOps</a></span><span class="level-item">38分で読む (約5634語)</span></div></div><h1 class="title is-3 is-size-4-mobile">Lambda CI/CD アーキテクチャ - 3. 実装ガイドライン</h1><div class="content"><h2 id="ドキュメント構成"><a href="#ドキュメント構成" class="headerlink" title="ドキュメント構成"></a>ドキュメント構成</h2><ul>
<li><a href="/2025/11/02/lambda-cicd-01-principles/" title="Lambda CI&#x2F;CD アーキテクチャ - 1. 環境構築における方針">1. CI&#x2F;CD環境構築における方針</a></li>
<li><a href="/2025/11/02/lambda-cicd-02-components/" title="Lambda CI&#x2F;CD アーキテクチャ - 2. 構成要素と役割">2. 具体的な構成要素と役割</a></li>
<li>→ 3. 各構成要素の実装に関する留意点</li>
<li><a href="/2025/11/02/lambda-cicd-04-tradeoffs/" title="Lambda CI&#x2F;CD アーキテクチャ - 4. メリット・デメリット">4. メリットとデメリットとして認識すべきこと</a></li>
</ul>
<h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ol>
<li><a href="#terraform%E5%AE%9F%E8%A3%85%E3%82%AC%E3%82%A4%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3">Terraform実装ガイドライン</a></li>
<li><a href="#sam%E5%AE%9F%E8%A3%85%E3%82%AC%E3%82%A4%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3">SAM実装ガイドライン</a></li>
<li><a href="#github-actions%E5%AE%9F%E8%A3%85%E3%82%AC%E3%82%A4%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3">GitHub Actions実装ガイドライン</a></li>
<li><a href="#%E5%91%BD%E5%90%8D%E8%A6%8F%E5%89%87%E3%81%A8%E3%82%BF%E3%82%B0%E6%88%A6%E7%95%A5">命名規則とタグ戦略</a></li>
<li><a href="#%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E8%80%83%E6%85%AE%E4%BA%8B%E9%A0%85">セキュリティ考慮事項</a></li>
<li><a href="#%E7%9B%A3%E8%A6%96%E3%81%A8%E3%83%AD%E3%82%AE%E3%83%B3%E3%82%B0">監視とロギング</a></li>
</ol>
<hr>
<h2 id="Terraform実装ガイドライン"><a href="#Terraform実装ガイドライン" class="headerlink" title="Terraform実装ガイドライン"></a>Terraform実装ガイドライン</h2><span id="more"></span>


<h3 id="IAMロール・ポリシー管理"><a href="#IAMロール・ポリシー管理" class="headerlink" title="IAMロール・ポリシー管理"></a>IAMロール・ポリシー管理</h3><h4 id="基本方針"><a href="#基本方針" class="headerlink" title="基本方針"></a>基本方針</h4><p>原則:<br>✓ 最小権限の原則（Principle of Least Privilege）<br>✓ ロールベースアクセス制御（RBAC）<br>✓ ポリシーの再利用性<br>✓ 明示的な権限付与</p>
<h4 id="Lambda実行ロールの実装"><a href="#Lambda実行ロールの実装" class="headerlink" title="Lambda実行ロールの実装"></a>Lambda実行ロールの実装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"># terraform-infrastructure/iam/lambda-roles.tf</span><br><span class="line"></span><br><span class="line"># 基本的な実行ロール</span><br><span class="line">resource &quot;aws_iam_role&quot; &quot;lambda_execution&quot; &#123;</span><br><span class="line">  name        = &quot;lambda-execution-role&quot;</span><br><span class="line">  description = &quot;Basic execution role for Lambda functions&quot;</span><br><span class="line">  </span><br><span class="line">  assume_role_policy = jsonencode(&#123;</span><br><span class="line">    Version = &quot;2012-10-17&quot;</span><br><span class="line">    Statement = [&#123;</span><br><span class="line">      Action = &quot;sts:AssumeRole&quot;</span><br><span class="line">      Effect = &quot;Allow&quot;</span><br><span class="line">      Principal = &#123;</span><br><span class="line">        Service = &quot;lambda.amazonaws.com&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Purpose     = &quot;LambdaExecution&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 基本的なロギング権限</span><br><span class="line">resource &quot;aws_iam_role_policy_attachment&quot; &quot;lambda_basic_execution&quot; &#123;</span><br><span class="line">  role       = aws_iam_role.lambda_execution.name</span><br><span class="line">  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># VPC内実行の権限</span><br><span class="line">resource &quot;aws_iam_role_policy_attachment&quot; &quot;lambda_vpc_execution&quot; &#123;</span><br><span class="line">  role       = aws_iam_role.lambda_execution.name</span><br><span class="line">  policy_arn = &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># カスタムポリシー（アプリケーション固有の権限）</span><br><span class="line">resource &quot;aws_iam_role_policy&quot; &quot;lambda_application_policy&quot; &#123;</span><br><span class="line">  name = &quot;lambda-application-policy&quot;</span><br><span class="line">  role = aws_iam_role.lambda_execution.id</span><br><span class="line">  </span><br><span class="line">  policy = jsonencode(&#123;</span><br><span class="line">    Version = &quot;2012-10-17&quot;</span><br><span class="line">    Statement = [</span><br><span class="line">      # S3アクセス（特定のバケットのみ）</span><br><span class="line">      &#123;</span><br><span class="line">        Sid    = &quot;S3Access&quot;</span><br><span class="line">        Effect = &quot;Allow&quot;</span><br><span class="line">        Action = [</span><br><span class="line">          &quot;s3:GetObject&quot;,</span><br><span class="line">          &quot;s3:PutObject&quot;</span><br><span class="line">        ]</span><br><span class="line">        Resource = [</span><br><span class="line">          &quot;$&#123;aws_s3_bucket.data.arn&#125;/*&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      # DynamoDBアクセス（特定のテーブルのみ）</span><br><span class="line">      &#123;</span><br><span class="line">        Sid    = &quot;DynamoDBAccess&quot;</span><br><span class="line">        Effect = &quot;Allow&quot;</span><br><span class="line">        Action = [</span><br><span class="line">          &quot;dynamodb:GetItem&quot;,</span><br><span class="line">          &quot;dynamodb:PutItem&quot;,</span><br><span class="line">          &quot;dynamodb:Query&quot;,</span><br><span class="line">          &quot;dynamodb:UpdateItem&quot;</span><br><span class="line">        ]</span><br><span class="line">        Resource = [</span><br><span class="line">          aws_dynamodb_table.orders.arn,</span><br><span class="line">          &quot;$&#123;aws_dynamodb_table.orders.arn&#125;/index/*&quot;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      # Secrets Managerアクセス（特定のシークレットのみ）</span><br><span class="line">      &#123;</span><br><span class="line">        Sid    = &quot;SecretsManagerAccess&quot;</span><br><span class="line">        Effect = &quot;Allow&quot;</span><br><span class="line">        Action = [</span><br><span class="line">          &quot;secretsmanager:GetSecretValue&quot;</span><br><span class="line">        ]</span><br><span class="line">        Resource = [</span><br><span class="line">          aws_secretsmanager_secret.api_keys.arn</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      # SQS送信（特定のキューのみ）</span><br><span class="line">      &#123;</span><br><span class="line">        Sid    = &quot;SQSSendMessage&quot;</span><br><span class="line">        Effect = &quot;Allow&quot;</span><br><span class="line">        Action = [</span><br><span class="line">          &quot;sqs:SendMessage&quot;</span><br><span class="line">        ]</span><br><span class="line">        Resource = [</span><br><span class="line">          aws_sqs_queue.notifications.arn</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="留意点"><a href="#留意点" class="headerlink" title="留意点"></a>留意点</h4><p>重要な考慮事項:</p>
<ol>
<li><p>権限の細分化:<br>問題: 全てのS3バケットへのアクセスを許可<br>解決: 特定のバケット・プレフィックスに限定</p>
<p>悪い例:<br>  Resource &#x3D; “arn:aws:s3:::*”</p>
<p>良い例:<br>  Resource &#x3D; [<br>“${aws_s3_bucket.data.arn}&#x2F;uploads&#x2F;<em>“,<br>“${aws_s3_bucket.data.arn}&#x2F;processed&#x2F;</em>“<br>  ]</p>
</li>
<li><p>条件付きアクセス:<br>推奨: 条件を使って更に制限</p>
<p>例: VPC内からのみアクセス可能<br>Condition &#x3D; {<br>  StringEquals &#x3D; {<br>“aws:SourceVpc” &#x3D; aws_vpc.main.id<br>  }<br>}</p>
</li>
<li><p>ポリシーのバージョン管理:</p>
<ul>
<li>変更時は必ずPull Request</li>
<li>レビューは複数人で実施</li>
<li>本番適用前にstagingで検証</li>
</ul>
</li>
<li><p>定期的なレビュー:</p>
<ul>
<li>四半期ごとに権限を見直し</li>
<li>不要な権限は削除</li>
<li>AWS Access Analyzerを活用</li>
</ul>
</li>
</ol>
<h3 id="VPC・ネットワーク設定"><a href="#VPC・ネットワーク設定" class="headerlink" title="VPC・ネットワーク設定"></a>VPC・ネットワーク設定</h3><h4 id="基本構成"><a href="#基本構成" class="headerlink" title="基本構成"></a>基本構成</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"># terraform-infrastructure/vpc/main.tf</span><br><span class="line"></span><br><span class="line"># VPC</span><br><span class="line">resource &quot;aws_vpc&quot; &quot;main&quot; &#123;</span><br><span class="line">  cidr_block           = var.vpc_cidr</span><br><span class="line">  enable_dns_hostnames = true</span><br><span class="line">  enable_dns_support   = true</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name        = &quot;$&#123;var.project_name&#125;-vpc&quot;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># プライベートサブネット（Lambda用）</span><br><span class="line">resource &quot;aws_subnet&quot; &quot;private&quot; &#123;</span><br><span class="line">  count = length(var.availability_zones)</span><br><span class="line">  </span><br><span class="line">  vpc_id            = aws_vpc.main.id</span><br><span class="line">  cidr_block        = cidrsubnet(var.vpc_cidr, 4, count.index)</span><br><span class="line">  availability_zone = var.availability_zones[count.index]</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name        = &quot;$&#123;var.project_name&#125;-private-$&#123;count.index + 1&#125;&quot;</span><br><span class="line">    Type        = &quot;Private&quot;</span><br><span class="line">    Purpose     = &quot;Lambda&quot;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Lambda用セキュリティグループ</span><br><span class="line">resource &quot;aws_security_group&quot; &quot;lambda&quot; &#123;</span><br><span class="line">  name        = &quot;$&#123;var.project_name&#125;-lambda-sg&quot;</span><br><span class="line">  description = &quot;Security group for Lambda functions&quot;</span><br><span class="line">  vpc_id      = aws_vpc.main.id</span><br><span class="line">  </span><br><span class="line">  # アウトバウンドは全て許可（インターネット、RDS等へのアクセス）</span><br><span class="line">  egress &#123;</span><br><span class="line">    from_port   = 0</span><br><span class="line">    to_port     = 0</span><br><span class="line">    protocol    = &quot;-1&quot;</span><br><span class="line">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">    description = &quot;Allow all outbound traffic&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name        = &quot;$&#123;var.project_name&#125;-lambda-sg&quot;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># RDS用セキュリティグループ</span><br><span class="line">resource &quot;aws_security_group&quot; &quot;rds&quot; &#123;</span><br><span class="line">  name        = &quot;$&#123;var.project_name&#125;-rds-sg&quot;</span><br><span class="line">  description = &quot;Security group for RDS&quot;</span><br><span class="line">  vpc_id      = aws_vpc.main.id</span><br><span class="line">  </span><br><span class="line">  # Lambdaからのアクセスのみ許可</span><br><span class="line">  ingress &#123;</span><br><span class="line">    from_port       = 5432  # PostgreSQL</span><br><span class="line">    to_port         = 5432</span><br><span class="line">    protocol        = &quot;tcp&quot;</span><br><span class="line">    security_groups = [aws_security_group.lambda.id]</span><br><span class="line">    description     = &quot;Allow Lambda functions to access RDS&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name        = &quot;$&#123;var.project_name&#125;-rds-sg&quot;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># NAT Gateway（Lambdaがインターネットにアクセスする場合）</span><br><span class="line">resource &quot;aws_eip&quot; &quot;nat&quot; &#123;</span><br><span class="line">  count  = var.enable_nat_gateway ? length(var.availability_zones) : 0</span><br><span class="line">  domain = &quot;vpc&quot;</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name        = &quot;$&#123;var.project_name&#125;-nat-eip-$&#123;count.index + 1&#125;&quot;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_nat_gateway&quot; &quot;main&quot; &#123;</span><br><span class="line">  count = var.enable_nat_gateway ? length(var.availability_zones) : 0</span><br><span class="line">  </span><br><span class="line">  allocation_id = aws_eip.nat[count.index].id</span><br><span class="line">  subnet_id     = aws_subnet.public[count.index].id</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name        = &quot;$&#123;var.project_name&#125;-nat-$&#123;count.index + 1&#125;&quot;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="留意点-1"><a href="#留意点-1" class="headerlink" title="留意点"></a>留意点</h4><p>VPC設定の注意点:</p>
<ol>
<li><p>サブネット設計:</p>
<ul>
<li>Lambda用にプライベートサブネットを用意</li>
<li>最低2つのAZ（可用性確保）</li>
<li>CIDR範囲は将来の拡張を考慮</li>
</ul>
</li>
<li><p>NAT Gateway:<br>コスト考慮:</p>
<ul>
<li>development: NAT Gateway なし（VPC外アクセス不要）</li>
<li>staging: 1つのNAT Gateway</li>
<li>production: AZごとにNAT Gateway（高可用性）</li>
</ul>
<p>注意:</p>
<ul>
<li>NAT Gatewayは従量課金（$0.045&#x2F;hour + データ転送費）</li>
<li>本当に必要か検討（VPC Endpointで代替可能な場合も）</li>
</ul>
</li>
<li><p>セキュリティグループ:</p>
<ul>
<li>Lambdaからのアウトバウンドは必要最小限に</li>
<li>インバウンドルールは不要（Lambdaは受信しない）</li>
<li>命名規則を統一</li>
</ul>
</li>
<li><p>VPC Endpoint:<br>推奨: S3、DynamoDB等へのアクセスにVPC Endpointを使用<br>メリット:</p>
<ul>
<li>NAT Gateway不要（コスト削減）</li>
<li>レイテンシ改善</li>
<li>セキュリティ向上</li>
</ul>
<p>例:<br>resource “aws_vpc_endpoint” “s3” {<br>  vpc_id       &#x3D; aws_vpc.main.id<br>  service_name &#x3D; “com.amazonaws.ap-northeast-1.s3”<br>}</p>
</li>
<li><p>DNS設定:</p>
<ul>
<li>enable_dns_hostnames &#x3D; true（RDS等の接続に必要）</li>
<li>enable_dns_support &#x3D; true</li>
</ul>
</li>
</ol>
<h3 id="SSM-Parameter-Store活用"><a href="#SSM-Parameter-Store活用" class="headerlink" title="SSM Parameter Store活用"></a>SSM Parameter Store活用</h3><h4 id="命名規則"><a href="#命名規則" class="headerlink" title="命名規則"></a>命名規則</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 統一された命名規則</span><br><span class="line"></span><br><span class="line"># 共有値（Terraform → SAM）</span><br><span class="line">/shared/&#123;service&#125;/&#123;resource-type&#125;/&#123;name&#125;</span><br><span class="line"></span><br><span class="line">例:</span><br><span class="line">/shared/iam/lambda-execution-role-arn</span><br><span class="line">/shared/vpc/private-subnet-ids</span><br><span class="line">/shared/vpc/lambda-security-group-id</span><br><span class="line">/shared/rds/endpoint</span><br><span class="line">/shared/rds/port</span><br><span class="line">/shared/rds/database-name</span><br><span class="line">/shared/s3/data-bucket-name</span><br><span class="line">/shared/dynamodb/orders-table-name</span><br><span class="line">/shared/sqs/notification-queue-url</span><br><span class="line">/shared/sns/alerts-topic-arn</span><br><span class="line"></span><br><span class="line"># アプリケーション情報（SAM → Terraform）</span><br><span class="line">/apps/&#123;function-name&#125;/&#123;key&#125;</span><br><span class="line"></span><br><span class="line">例:</span><br><span class="line">/apps/user-login-function/latest-version</span><br><span class="line">/apps/user-login-function/version-15/metadata</span><br><span class="line">/apps/user-login-function/deployed-at</span><br></pre></td></tr></table></figure>

<h4 id="実装パターン"><a href="#実装パターン" class="headerlink" title="実装パターン"></a>実装パターン</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># terraform-infrastructure/shared-values/main.tf</span><br><span class="line"></span><br><span class="line">locals &#123;</span><br><span class="line">  shared_parameters = &#123;</span><br><span class="line">    # IAM</span><br><span class="line">    &quot;iam/lambda-execution-role-arn&quot; = aws_iam_role.lambda_execution.arn</span><br><span class="line">    </span><br><span class="line">    # VPC</span><br><span class="line">    &quot;vpc/vpc-id&quot;                     = aws_vpc.main.id</span><br><span class="line">    &quot;vpc/private-subnet-ids&quot;         = join(&quot;,&quot;, aws_subnet.private[*].id)</span><br><span class="line">    &quot;vpc/lambda-security-group-id&quot;   = aws_security_group.lambda.id</span><br><span class="line">    </span><br><span class="line">    # RDS</span><br><span class="line">    &quot;rds/endpoint&quot;      = aws_db_instance.main.endpoint</span><br><span class="line">    &quot;rds/port&quot;          = aws_db_instance.main.port</span><br><span class="line">    &quot;rds/database-name&quot; = aws_db_instance.main.db_name</span><br><span class="line">    </span><br><span class="line">    # S3</span><br><span class="line">    &quot;s3/data-bucket-name&quot;    = aws_s3_bucket.data.id</span><br><span class="line">    &quot;s3/uploads-bucket-name&quot; = aws_s3_bucket.uploads.id</span><br><span class="line">    </span><br><span class="line">    # DynamoDB</span><br><span class="line">    &quot;dynamodb/orders-table-name&quot;    = aws_dynamodb_table.orders.name</span><br><span class="line">    &quot;dynamodb/sessions-table-name&quot;  = aws_dynamodb_table.sessions.name</span><br><span class="line">    </span><br><span class="line">    # SQS</span><br><span class="line">    &quot;sqs/notification-queue-url&quot; = aws_sqs_queue.notifications.url</span><br><span class="line">    &quot;sqs/dlq-queue-url&quot;          = aws_sqs_queue.dlq.url</span><br><span class="line">    </span><br><span class="line">    # SNS</span><br><span class="line">    &quot;sns/alerts-topic-arn&quot; = aws_sns_topic.alerts.arn</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 一括作成</span><br><span class="line">resource &quot;aws_ssm_parameter&quot; &quot;shared&quot; &#123;</span><br><span class="line">  for_each = local.shared_parameters</span><br><span class="line">  </span><br><span class="line">  name  = &quot;/shared/$&#123;each.key&#125;&quot;</span><br><span class="line">  type  = each.key == &quot;vpc/private-subnet-ids&quot; ? &quot;StringList&quot; : &quot;String&quot;</span><br><span class="line">  value = each.value</span><br><span class="line">  </span><br><span class="line">  tags = &#123;</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;</span><br><span class="line">    Purpose     = &quot;SharedConfiguration&quot;</span><br><span class="line">    Environment = var.environment</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="留意点-2"><a href="#留意点-2" class="headerlink" title="留意点"></a>留意点</h4><p>SSM Parameter Store使用時の注意:</p>
<ol>
<li><p>タイプの選択:</p>
<ul>
<li>String: 単一の値</li>
<li>StringList: カンマ区切りのリスト（サブネットID等）</li>
<li>SecureString: 暗号化が必要な値（パスワード等）</li>
</ul>
</li>
<li><p>更新の考慮:</p>
<ul>
<li>–overwrite オプションで上書き可能</li>
<li>古い値は履歴として保持されない（注意）</li>
<li>重要な値は別途バックアップ</li>
</ul>
</li>
<li><p>パフォーマンス:</p>
<ul>
<li>SAMデプロイ時に毎回取得</li>
<li>キャッシュされない</li>
<li>大量のパラメータは避ける（必要最小限）</li>
</ul>
</li>
<li><p>コスト:</p>
<ul>
<li>Standard tier: 10,000パラメータまで無料</li>
<li>Advanced tier: $0.05&#x2F;パラメータ&#x2F;月</li>
<li>通常はStandardで十分</li>
</ul>
</li>
<li><p>アクセス制御:</p>
<ul>
<li>IAMポリシーで制御</li>
<li>最小権限の原則</li>
<li>タグベースの制御も可能</li>
</ul>
</li>
</ol>
<hr>
<h2 id="SAM実装ガイドライン"><a href="#SAM実装ガイドライン" class="headerlink" title="SAM実装ガイドライン"></a>SAM実装ガイドライン</h2><h3 id="Lambda関数構成"><a href="#Lambda関数構成" class="headerlink" title="Lambda関数構成"></a>Lambda関数構成</h3><h4 id="ディレクトリ構造"><a href="#ディレクトリ構造" class="headerlink" title="ディレクトリ構造"></a>ディレクトリ構造</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">functions/</span><br><span class="line">├── auth/</span><br><span class="line">│   ├── login/</span><br><span class="line">│   │   ├── app.py                    # メインハンドラ</span><br><span class="line">│   │   ├── requirements.txt          # 依存関係</span><br><span class="line">│   │   ├── config.py                 # 設定</span><br><span class="line">│   │   ├── validators.py             # バリデーション</span><br><span class="line">│   │   └── tests/</span><br><span class="line">│   │       ├── test_app.py</span><br><span class="line">│   │       └── test_validators.py</span><br><span class="line">│   │</span><br><span class="line">│   ├── logout/</span><br><span class="line">│   └── refresh-token/</span><br><span class="line">│</span><br><span class="line">└── orders/</span><br><span class="line">    ├── create-order/</span><br><span class="line">    └── list-orders/</span><br></pre></td></tr></table></figure>

<h4 id="関数実装のベストプラクティス"><a href="#関数実装のベストプラクティス" class="headerlink" title="関数実装のベストプラクティス"></a>関数実装のベストプラクティス</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># functions/auth/login/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Any</span></span><br><span class="line"><span class="keyword">from</span> company.logger <span class="keyword">import</span> get_logger  <span class="comment"># Layerから</span></span><br><span class="line"><span class="keyword">from</span> company.auth <span class="keyword">import</span> verify_credentials  <span class="comment"># Layerから</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ロガーの初期化（グローバル）</span></span><br><span class="line">logger = get_logger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 環境変数の取得（グローバル）</span></span><br><span class="line">DB_ENDPOINT = os.environ[<span class="string">&#x27;DB_ENDPOINT&#x27;</span>]</span><br><span class="line">TABLE_NAME = os.environ[<span class="string">&#x27;TABLE_NAME&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接続の初期化（グローバル、再利用）</span></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line">dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">table = dynamodb.Table(TABLE_NAME)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>], context: <span class="type">Any</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Lambda関数のエントリーポイント</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        event: API Gatewayイベント</span></span><br><span class="line"><span class="string">        context: Lambdaコンテキスト</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        API Gatewayレスポンス</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># リクエストのログ</span></span><br><span class="line">        logger.info(<span class="string">&quot;Login attempt&quot;</span>, extra=&#123;</span><br><span class="line">            <span class="string">&quot;request_id&quot;</span>: context.request_id,</span><br><span class="line">            <span class="string">&quot;source_ip&quot;</span>: event.get(<span class="string">&#x27;requestContext&#x27;</span>, &#123;&#125;).get(<span class="string">&#x27;identity&#x27;</span>, &#123;&#125;).get(<span class="string">&#x27;sourceIp&#x27;</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># リクエストボディの解析</span></span><br><span class="line">        body = json.loads(event.get(<span class="string">&#x27;body&#x27;</span>, <span class="string">&#x27;&#123;&#125;&#x27;</span>))</span><br><span class="line">        username = body.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = body.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># バリデーション</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">            logger.warning(<span class="string">&quot;Missing credentials&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> error_response(<span class="number">400</span>, <span class="string">&quot;Username and password are required&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 認証処理</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> verify_credentials(username, password):</span><br><span class="line">            logger.warning(<span class="string">&quot;Invalid credentials&quot;</span>, extra=&#123;<span class="string">&quot;username&quot;</span>: username&#125;)</span><br><span class="line">            <span class="keyword">return</span> error_response(<span class="number">401</span>, <span class="string">&quot;Invalid credentials&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># セッション作成</span></span><br><span class="line">        session_token = create_session(username)</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">&quot;Login successful&quot;</span>, extra=&#123;<span class="string">&quot;username&quot;</span>: username&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;statusCode&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="string">&#x27;headers&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span>: json.dumps(&#123;</span><br><span class="line">                <span class="string">&#x27;token&#x27;</span>: session_token,</span><br><span class="line">                <span class="string">&#x27;username&#x27;</span>: username</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">&quot;Login failed&quot;</span>, extra=&#123;</span><br><span class="line">            <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e),</span><br><span class="line">            <span class="string">&quot;request_id&quot;</span>: context.request_id</span><br><span class="line">        &#125;, exc_info=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> error_response(<span class="number">500</span>, <span class="string">&quot;Internal server error&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">error_response</span>(<span class="params">status_code: <span class="built_in">int</span>, message: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;エラーレスポンスの生成&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;statusCode&#x27;</span>: status_code,</span><br><span class="line">        <span class="string">&#x27;headers&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="string">&#x27;*&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span>: json.dumps(&#123;<span class="string">&#x27;error&#x27;</span>: message&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_session</span>(<span class="params">username: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;セッション作成&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> uuid</span><br><span class="line">    <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line">    </span><br><span class="line">    session_token = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line">    expiry = datetime.utcnow() + timedelta(hours=<span class="number">24</span>)</span><br><span class="line">    </span><br><span class="line">    table.put_item(</span><br><span class="line">        Item=&#123;</span><br><span class="line">            <span class="string">&#x27;token&#x27;</span>: session_token,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">            <span class="string">&#x27;expiry&#x27;</span>: <span class="built_in">int</span>(expiry.timestamp())</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> session_token</span><br></pre></td></tr></table></figure>

<h4 id="留意点-3"><a href="#留意点-3" class="headerlink" title="留意点"></a>留意点</h4><p>Lambda関数実装のポイント:</p>
<ol>
<li><p>グローバル変数の活用:<br>理由: コールドスタート時のみ初期化、その後は再利用</p>
<p>推奨:</p>
<ul>
<li>ロガー</li>
<li>AWS SDKクライアント（boto3等）</li>
<li>データベース接続</li>
<li>設定値</li>
</ul>
<p>非推奨:</p>
<ul>
<li>リクエスト固有のデータ</li>
<li>ステートフルな情報</li>
</ul>
</li>
<li><p>エラーハンドリング:<br>必須:</p>
<ul>
<li>トップレベルのtry-except</li>
<li>適切なログ出力</li>
<li>ユーザーフレンドリーなエラーメッセージ</li>
<li>内部エラー詳細は隠蔽</li>
</ul>
</li>
<li><p>タイムアウト設定:<br>考慮事項:</p>
<ul>
<li>処理時間 + マージン</li>
<li>長すぎると課金増加</li>
<li>短すぎるとタイムアウト頻発</li>
</ul>
<p>推奨:</p>
<ul>
<li>軽量API: 3-10秒</li>
<li>データ処理: 30-60秒</li>
<li>バッチ処理: 300-900秒（最大15分）</li>
</ul>
</li>
<li><p>メモリ設定:<br>ポイント:</p>
<ul>
<li>メモリ↑ &#x3D; CPU性能↑</li>
<li>コストとパフォーマンスのバランス</li>
<li>実測して最適化</li>
</ul>
<p>開始値:</p>
<ul>
<li>軽量API: 512MB</li>
<li>データ処理: 1024MB</li>
<li>重い処理: 2048MB以上</li>
</ul>
</li>
<li><p>環境変数:<br>使い分け:</p>
<ul>
<li>環境ごとに変わる値: 環境変数</li>
<li>機密情報: Secrets Manager &#x2F; SSM Parameter Store</li>
<li>固定値: コードに埋め込みも可</li>
</ul>
</li>
</ol>
<h3 id="Layer管理"><a href="#Layer管理" class="headerlink" title="Layer管理"></a>Layer管理</h3><h4 id="Layer構造"><a href="#Layer構造" class="headerlink" title="Layer構造"></a>Layer構造</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">layers/</span><br><span class="line">├── dependencies/              # 外部ライブラリ</span><br><span class="line">│   ├── python/               # ランタイム別ディレクトリ</span><br><span class="line">│   │   └── lib/</span><br><span class="line">│   │       └── python3.11/</span><br><span class="line">│   │           └── site-packages/</span><br><span class="line">│   │               ├── requests/</span><br><span class="line">│   │               ├── boto3/</span><br><span class="line">│   │               └── ...</span><br><span class="line">│   └── requirements.txt</span><br><span class="line">│</span><br><span class="line">└── company-utils/            # 自社共通コード</span><br><span class="line">    └── python/</span><br><span class="line">        └── company/</span><br><span class="line">            ├── __init__.py</span><br><span class="line">            ├── logger.py</span><br><span class="line">            ├── auth.py</span><br><span class="line">            ├── database.py</span><br><span class="line">            └── validators.py</span><br></pre></td></tr></table></figure>

<h4 id="SAMテンプレート"><a href="#SAMテンプレート" class="headerlink" title="SAMテンプレート"></a>SAMテンプレート</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># template.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="comment"># 依存関係Layer（頻繁に更新）</span></span><br><span class="line">  <span class="attr">DependenciesLayer:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Serverless::LayerVersion</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">LayerName:</span> <span class="type">!Sub</span> <span class="string">&#x27;$&#123;AWS::StackName&#125;-dependencies&#x27;</span></span><br><span class="line">      <span class="attr">Description:</span> <span class="string">External</span> <span class="string">dependencies</span> <span class="string">(requests,</span> <span class="string">boto3,</span> <span class="string">etc.)</span></span><br><span class="line">      <span class="attr">ContentUri:</span> <span class="string">layers/dependencies/</span></span><br><span class="line">      <span class="attr">CompatibleRuntimes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python3.11</span></span><br><span class="line">      <span class="attr">RetentionPolicy:</span> <span class="string">Retain</span></span><br><span class="line">    <span class="attr">Metadata:</span></span><br><span class="line">      <span class="attr">BuildMethod:</span> <span class="string">python3.11</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 共通ユーティリティLayer（安定）</span></span><br><span class="line">  <span class="attr">CompanyUtilsLayer:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Serverless::LayerVersion</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">LayerName:</span> <span class="string">company-utils</span></span><br><span class="line">      <span class="attr">Description:</span> <span class="string">Company-wide</span> <span class="string">utility</span> <span class="string">functions</span></span><br><span class="line">      <span class="attr">ContentUri:</span> <span class="string">layers/company-utils/</span></span><br><span class="line">      <span class="attr">CompatibleRuntimes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python3.11</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python3.10</span></span><br><span class="line">      <span class="attr">RetentionPolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure>

<h4 id="留意点-4"><a href="#留意点-4" class="headerlink" title="留意点"></a>留意点</h4><p>Layer管理のベストプラクティス:</p>
<ol>
<li><p>Layer分割戦略:<br>推奨:</p>
<ul>
<li>外部ライブラリLayer（頻繁に更新）</li>
<li>自社共通コードLayer（安定）</li>
</ul>
<p>理由:</p>
<ul>
<li>変更頻度が異なる</li>
<li>ビルド時間の最適化</li>
<li>バージョン管理の明確化</li>
</ul>
</li>
<li><p>サイズ制限:<br>制約:</p>
<ul>
<li>Layer単体: 50MB（圧縮後）</li>
<li>全Layer合計: 250MB（展開後）</li>
</ul>
<p>対策:</p>
<ul>
<li>不要なファイル除外（tests&#x2F;, docs&#x2F;）</li>
<li>必要なモジュールのみインストール</li>
<li>複数Layerに分割</li>
</ul>
</li>
<li><p>バージョン管理:<br>重要:</p>
<ul>
<li>Layerは不変（Immutable）</li>
<li>更新時は新バージョン作成</li>
<li>関数は特定バージョンを参照</li>
</ul>
<p>注意:</p>
<ul>
<li>古いバージョンは使われなくなったら削除</li>
<li>RetentionPolicy: Retain 推奨</li>
</ul>
</li>
<li><p>ビルドプロセス:<br>SAMの自動ビルド:</p>
<ul>
<li>BuildMethod指定で自動化</li>
<li>requirements.txt から自動インストール</li>
<li>アーキテクチャ考慮（x86_64 &#x2F; arm64）</li>
</ul>
</li>
<li><p>インポートパス:<br>ポイント:</p>
<ul>
<li>&#x2F;opt&#x2F;python がPYTHONPATHに自動追加</li>
<li>from company.logger import …</li>
<li>絶対インポートを使用</li>
</ul>
</li>
<li><p>互換性:<br>確認事項:</p>
<ul>
<li>CompatibleRuntimes を明示</li>
<li>Pythonバージョンの互換性</li>
<li>ネイティブライブラリの場合はアーキテクチャ</li>
</ul>
</li>
</ol>
<h3 id="エイリアス設定"><a href="#エイリアス設定" class="headerlink" title="エイリアス設定"></a>エイリアス設定</h3><h4 id="実装パターン-1"><a href="#実装パターン-1" class="headerlink" title="実装パターン"></a>実装パターン</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># template.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">UserLoginFunction:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Serverless::Function</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">FunctionName:</span> <span class="string">user-login-function</span></span><br><span class="line">      <span class="attr">CodeUri:</span> <span class="string">functions/auth/login/</span></span><br><span class="line">      <span class="attr">Handler:</span> <span class="string">app.lambda_handler</span></span><br><span class="line">      <span class="comment"># AutoPublishAliasは使わない</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Developmentエイリアス（$LATEST）</span></span><br><span class="line">  <span class="attr">UserLoginDevAlias:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Lambda::Alias</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">FunctionName:</span> <span class="type">!Ref</span> <span class="string">UserLoginFunction</span></span><br><span class="line">      <span class="attr">FunctionVersion:</span> <span class="string">$LATEST</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">development</span></span><br><span class="line">      <span class="attr">Description:</span> <span class="string">Development</span> <span class="string">environment</span> <span class="bullet">-</span> <span class="string">always</span> <span class="string">latest</span> <span class="string">code</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Stagingエイリアス（自動更新）</span></span><br><span class="line">  <span class="attr">UserLoginStagingAlias:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Lambda::Alias</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">FunctionName:</span> <span class="type">!Ref</span> <span class="string">UserLoginFunction</span></span><br><span class="line">      <span class="attr">FunctionVersion:</span> <span class="type">!GetAtt</span> <span class="string">UserLoginStagingVersion.Version</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">staging</span></span><br><span class="line">      <span class="attr">Description:</span> <span class="type">!Sub</span> <span class="string">&quot;Staging - Version $&#123;UserLoginStagingVersion.Version&#125;&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">UserLoginStagingVersion:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Lambda::Version</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">FunctionName:</span> <span class="type">!Ref</span> <span class="string">UserLoginFunction</span></span><br><span class="line">      <span class="attr">Description:</span> <span class="type">!Sub</span> <span class="string">|</span></span><br><span class="line"><span class="string">        Deployed: $&#123;AWS::StackName&#125;</span></span><br><span class="line"><span class="string">        Commit: $&#123;GitCommitSha&#125;</span></span><br><span class="line"><span class="string">        Date: $&#123;DeploymentDate&#125;</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">  <span class="comment"># Productionエイリアス（手動更新）</span></span><br><span class="line">  <span class="attr">UserLoginProdAlias:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Lambda::Alias</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">FunctionName:</span> <span class="type">!Ref</span> <span class="string">UserLoginFunction</span></span><br><span class="line">      <span class="attr">FunctionVersion:</span> <span class="string">&quot;1&quot;</span>  <span class="comment"># 初期値、後で手動更新</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="string">production</span></span><br><span class="line">      <span class="attr">Description:</span> <span class="string">Production</span> <span class="string">environment</span></span><br><span class="line">    <span class="attr">DeletionPolicy:</span> <span class="string">Retain</span></span><br><span class="line">    <span class="attr">UpdateReplacePolicy:</span> <span class="string">Retain</span></span><br></pre></td></tr></table></figure>

<h4 id="留意点-5"><a href="#留意点-5" class="headerlink" title="留意点"></a>留意点</h4><p>エイリアス設定の注意点:</p>
<ol>
<li><p>AutoPublishAliasを使わない理由:<br>制約:</p>
<ul>
<li>デプロイ &#x3D; リリース（分離できない）</li>
<li>細かい制御が困難</li>
<li>複数環境の管理が複雑</li>
</ul>
<p>代替:</p>
<ul>
<li>AWS::Lambda::Version で明示的に管理</li>
<li>AWS::Lambda::Alias で環境を分離</li>
</ul>
</li>
<li><p>バージョン番号の扱い:<br>注意:</p>
<ul>
<li>Versionリソースは毎デプロイで新規作成</li>
<li>論理IDが同じでも物理的には別バージョン</li>
<li>CloudFormationスタック更新で自動管理</li>
</ul>
</li>
<li><p>DeletionPolicy:<br>推奨:</p>
<ul>
<li>production: Retain（削除しない）</li>
<li>staging: Delete（削除可能）</li>
</ul>
<p>理由:</p>
<ul>
<li>本番は誤削除防止</li>
<li>ロールバック用に保持</li>
</ul>
</li>
<li><p>エイリアス名の統一:<br>規約:</p>
<ul>
<li>development（小文字）</li>
<li>staging（小文字）</li>
<li>production（小文字）</li>
</ul>
<p>理由:</p>
<ul>
<li>全関数で統一</li>
<li>スクリプトで扱いやすい</li>
</ul>
</li>
<li><p>ProvisionedConcurrency:<br>考慮:</p>
<ul>
<li>コールドスタート対策</li>
<li>本番のみ設定（コスト高）</li>
</ul>
<p>例:<br>UserLoginProdAlias:<br>  Properties:<br>    ProvisionedConcurrencyConfig:<br>      ProvisionedConcurrentExecutions: 5</p>
</li>
</ol>
<hr>
<h2 id="GitHub-Actions実装ガイドライン"><a href="#GitHub-Actions実装ガイドライン" class="headerlink" title="GitHub Actions実装ガイドライン"></a>GitHub Actions実装ガイドライン</h2><h3 id="デプロイワークフロー"><a href="#デプロイワークフロー" class="headerlink" title="デプロイワークフロー"></a>デプロイワークフロー</h3><h4 id="Staging自動デプロイ"><a href="#Staging自動デプロイ" class="headerlink" title="Staging自動デプロイ"></a>Staging自動デプロイ</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/deploy-staging.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">Staging</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;functions/**&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;layers/**&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;template.yaml&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;samconfig.toml&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">AWS_REGION:</span> <span class="string">ap-northeast-1</span></span><br><span class="line">  <span class="attr">ENVIRONMENT:</span> <span class="string">staging</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 環境の指定（承認不要）</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">staging</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">https://staging.example.com</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">code</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span>  <span class="comment"># 全履歴取得（git diff用）</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Python</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-python@v5</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">python-version:</span> <span class="string">&#x27;3.11&#x27;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">SAM</span> <span class="string">CLI</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/setup-sam@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">AWS</span> <span class="string">Credentials</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">role-to-assume:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_LAMBDA_DEPLOY_ROLE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">role-session-name:</span> <span class="string">GitHubActions-Staging</span></span><br><span class="line">          <span class="attr">aws-region:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.AWS_REGION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SAM</span> <span class="string">Build</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sam build \</span></span><br><span class="line"><span class="string">            --use-container \</span></span><br><span class="line"><span class="string">            --parallel</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SAM</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sam deploy \</span></span><br><span class="line"><span class="string">            --no-confirm-changeset \</span></span><br><span class="line"><span class="string">            --no-fail-on-empty-changeset \</span></span><br><span class="line"><span class="string">            --stack-name lambda-app-staging \</span></span><br><span class="line"><span class="string">            --capabilities CAPABILITY_IAM \</span></span><br><span class="line"><span class="string">            --region $&#123;&#123; env.AWS_REGION &#125;&#125; \</span></span><br><span class="line"><span class="string">            --parameter-overrides \</span></span><br><span class="line"><span class="string">              Environment=staging</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">Function</span> <span class="string">Names</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">functions</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          # デプロイされた関数一覧を取得</span></span><br><span class="line"><span class="string">          FUNCTIONS=$(aws cloudformation describe-stack-resources \</span></span><br><span class="line"><span class="string">            --stack-name lambda-app-staging \</span></span><br><span class="line"><span class="string">            --query &quot;StackResources[?ResourceType==&#x27;AWS::Lambda::Function&#x27;].PhysicalResourceId&quot; \</span></span><br><span class="line"><span class="string">            --output text)</span></span><br><span class="line"><span class="string">          echo &quot;functions=$FUNCTIONS&quot; &gt;&gt; $GITHUB_OUTPUT</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Publish</span> <span class="string">Versions</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">versions</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          VERSIONS=&quot;&quot;</span></span><br><span class="line"><span class="string">          for FUNCTION in $&#123;&#123; steps.functions.outputs.functions &#125;&#125;; do</span></span><br><span class="line"><span class="string">            VERSION=$(aws lambda publish-version \</span></span><br><span class="line"><span class="string">              --function-name $FUNCTION \</span></span><br><span class="line"><span class="string">              --description &quot;Commit: $&#123;&#123; github.sha &#125;&#125; | Branch: $&#123;&#123; github.ref_name &#125;&#125;&quot; \</span></span><br><span class="line"><span class="string">              --query &#x27;Version&#x27; \</span></span><br><span class="line"><span class="string">              --output text)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            echo &quot;Published $FUNCTION version $VERSION&quot;</span></span><br><span class="line"><span class="string">            VERSIONS=&quot;$VERSIONS $FUNCTION:$VERSION&quot;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            # SSMに保存</span></span><br><span class="line"><span class="string">            aws ssm put-parameter \</span></span><br><span class="line"><span class="string">              --name &quot;/apps/$FUNCTION/latest-version&quot; \</span></span><br><span class="line"><span class="string">              --value &quot;$VERSION&quot; \</span></span><br><span class="line"><span class="string">              --type String \</span></span><br><span class="line"><span class="string">              --overwrite</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            # メタデータも保存</span></span><br><span class="line"><span class="string">            aws ssm put-parameter \</span></span><br><span class="line"><span class="string">              --name &quot;/apps/$FUNCTION/version-$VERSION/metadata&quot; \</span></span><br><span class="line"><span class="string">              --value &quot;&#123;</span></span><br><span class="line"><span class="string">                \&quot;version\&quot;: \&quot;$VERSION\&quot;,</span></span><br><span class="line"><span class="string">                \&quot;commit\&quot;: \&quot;$&#123;&#123; github.sha &#125;&#125;\&quot;,</span></span><br><span class="line"><span class="string">                \&quot;branch\&quot;: \&quot;$&#123;&#123; github.ref_name &#125;&#125;\&quot;,</span></span><br><span class="line"><span class="string">                \&quot;deployed_at\&quot;: \&quot;$(date -u +%Y-%m-%dT%H:%M:%SZ)\&quot;,</span></span><br><span class="line"><span class="string">                \&quot;deployed_by\&quot;: \&quot;$&#123;&#123; github.actor &#125;&#125;\&quot;</span></span><br><span class="line"><span class="string">              &#125;&quot; \</span></span><br><span class="line"><span class="string">              --type String \</span></span><br><span class="line"><span class="string">              --overwrite</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string">          echo &quot;versions=$VERSIONS&quot; &gt;&gt; $GITHUB_OUTPUT</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">Smoke</span> <span class="string">Tests</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          # 基本的な疎通確認</span></span><br><span class="line"><span class="string">          for FUNCTION in $&#123;&#123; steps.functions.outputs.functions &#125;&#125;; do</span></span><br><span class="line"><span class="string">            echo &quot;Testing $FUNCTION...&quot;</span></span><br><span class="line"><span class="string">            aws lambda invoke \</span></span><br><span class="line"><span class="string">              --function-name $FUNCTION:staging \</span></span><br><span class="line"><span class="string">              --payload &#x27;&#123;&quot;test&quot;: true&#125;&#x27; \</span></span><br><span class="line"><span class="string">              --log-type Tail \</span></span><br><span class="line"><span class="string">              response.json</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            # レスポンス確認</span></span><br><span class="line"><span class="string">            if grep -q &quot;errorMessage&quot; response.json; then</span></span><br><span class="line"><span class="string">              echo &quot;❌ Smoke test failed for $FUNCTION&quot;</span></span><br><span class="line"><span class="string">              cat response.json</span></span><br><span class="line"><span class="string">              exit 1</span></span><br><span class="line"><span class="string">            fi</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            echo &quot;✅ Smoke test passed for $FUNCTION&quot;</span></span><br><span class="line"><span class="string">          done</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Notify</span> <span class="string">Slack</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">always()</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">slackapi/slack-github-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">webhook-url:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SLACK_WEBHOOK_URL</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">payload:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              &quot;text&quot;: &quot;$&#123;&#123; job.status == &#x27;success&#x27; &amp;&amp; &#x27;✅&#x27; || &#x27;❌&#x27; &#125;&#125; Staging Deployment&quot;,</span></span><br><span class="line"><span class="string">              &quot;blocks&quot;: [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;type&quot;: &quot;section&quot;,</span></span><br><span class="line"><span class="string">                  &quot;text&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;type&quot;: &quot;mrkdwn&quot;,</span></span><br><span class="line"><span class="string">                    &quot;text&quot;: &quot;*Staging Deployment $&#123;&#123; job.status &#125;&#125;*\n\n*Commit:* $&#123;&#123; github.sha &#125;&#125;\n*Branch:* $&#123;&#123; github.ref_name &#125;&#125;\n*Author:* $&#123;&#123; github.actor &#125;&#125;\n*Versions:* $&#123;&#123; steps.versions.outputs.versions &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">                  &#125;</span></span><br><span class="line"><span class="string">                &#125;,</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;type&quot;: &quot;actions&quot;,</span></span><br><span class="line"><span class="string">                  &quot;elements&quot;: [</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                      &quot;type&quot;: &quot;button&quot;,</span></span><br><span class="line"><span class="string">                      &quot;text&quot;: &#123;&quot;type&quot;: &quot;plain_text&quot;, &quot;text&quot;: &quot;View Workflow&quot;&#125;,</span></span><br><span class="line"><span class="string">                      &quot;url&quot;: &quot;$&#123;&#123; github.server_url &#125;&#125;/$&#123;&#123; github.repository &#125;&#125;/actions/runs/$&#123;&#123; github.run_id &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">                    &#125;,</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                      &quot;type&quot;: &quot;button&quot;,</span></span><br><span class="line"><span class="string">                      &quot;text&quot;: &#123;&quot;type&quot;: &quot;plain_text&quot;, &quot;text&quot;: &quot;Request Production Release&quot;&#125;,</span></span><br><span class="line"><span class="string">                      &quot;url&quot;: &quot;$&#123;&#123; github.server_url &#125;&#125;/$&#123;&#123; github.repository &#125;&#125;/actions/workflows/release-production.yml&quot;,</span></span><br><span class="line"><span class="string">                      &quot;style&quot;: &quot;primary&quot;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                  ]</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              ]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="Production手動リリース"><a href="#Production手動リリース" class="headerlink" title="Production手動リリース"></a>Production手動リリース</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .github/workflows/release-production.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">Release</span> <span class="string">to</span> <span class="string">Production</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">      <span class="attr">function_name:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Function name to release&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">choice</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">user-login-function</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">user-logout-function</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">create-order-function</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">process-payment-function</span></span><br><span class="line">      <span class="attr">version:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Version number to release (from staging)&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">      <span class="attr">strategy:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Release strategy&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">choice</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">immediate</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">canary-10</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">blue-green</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">canary-10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">AWS_REGION:</span> <span class="string">ap-northeast-1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">validate:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">outputs:</span></span><br><span class="line">      <span class="attr">current_version:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.current.outputs.version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">metadata:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.metadata.outputs.data</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">AWS</span> <span class="string">Credentials</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">role-to-assume:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_LAMBDA_DEPLOY_ROLE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">aws-region:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.AWS_REGION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">Current</span> <span class="string">Production</span> <span class="string">Version</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">current</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          CURRENT=$(aws lambda get-alias \</span></span><br><span class="line"><span class="string">            --function-name $&#123;&#123; inputs.function_name &#125;&#125; \</span></span><br><span class="line"><span class="string">            --name production \</span></span><br><span class="line"><span class="string">            --query &#x27;FunctionVersion&#x27; \</span></span><br><span class="line"><span class="string">            --output text)</span></span><br><span class="line"><span class="string">          echo &quot;version=$CURRENT&quot; &gt;&gt; $GITHUB_OUTPUT</span></span><br><span class="line"><span class="string">          echo &quot;Current production version: $CURRENT&quot;</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Validate</span> <span class="string">New</span> <span class="string">Version</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          aws lambda get-function \</span></span><br><span class="line"><span class="string">            --function-name $&#123;&#123; inputs.function_name &#125;&#125; \</span></span><br><span class="line"><span class="string">            --qualifier $&#123;&#123; inputs.version &#125;&#125;</span></span><br><span class="line"><span class="string"></span>          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;✅ Version $<span class="template-variable">&#123;&#123; inputs.version &#125;&#125;</span> exists&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">Version</span> <span class="string">Metadata</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">metadata</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          METADATA=$(aws ssm get-parameter \</span></span><br><span class="line"><span class="string">            --name &quot;/apps/$&#123;&#123; inputs.function_name &#125;&#125;/version-$&#123;&#123; inputs.version &#125;&#125;/metadata&quot; \</span></span><br><span class="line"><span class="string">            --query &#x27;Parameter.Value&#x27; \</span></span><br><span class="line"><span class="string">            --output text 2&gt;/dev/null || echo &#x27;&#123;&#125;&#x27;)</span></span><br><span class="line"><span class="string"></span>          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;data=$METADATA&quot;</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_OUTPUT</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Version metadata:&quot;</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;$METADATA&quot;</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">.</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">approve:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">validate</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 本番環境（承認必須）</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">https://production.example.com</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Approval</span> <span class="string">Required</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;⏳ Waiting for approval to release to production&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Function: $&#123;&#123; inputs.function_name &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Version: $&#123;&#123; inputs.version &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Current: $&#123;&#123; needs.validate.outputs.current_version &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          echo &quot;Strategy: $&#123;&#123; inputs.strategy &#125;&#125;&quot;</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="attr">needs:</span> [<span class="string">validate</span>, <span class="string">approve</span>]</span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">scripts</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">sparse-checkout:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            scripts/</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">AWS</span> <span class="string">Credentials</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">role-to-assume:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.AWS_LAMBDA_DEPLOY_ROLE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">aws-region:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.AWS_REGION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="bullet">-</span> <span class="string">Immediate</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">inputs.strategy</span> <span class="string">==</span> <span class="string">&#x27;immediate&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          aws lambda update-alias \</span></span><br><span class="line"><span class="string">            --function-name $&#123;&#123; inputs.function_name &#125;&#125; \</span></span><br><span class="line"><span class="string">            --name production \</span></span><br><span class="line"><span class="string">            --function-version $&#123;&#123; inputs.version &#125;&#125;</span></span><br><span class="line"><span class="string"></span>          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;✅ Immediately released version $<span class="template-variable">&#123;&#123; inputs.version &#125;&#125;</span>&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="bullet">-</span> <span class="string">Canary</span> <span class="number">10</span><span class="string">%</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">inputs.strategy</span> <span class="string">==</span> <span class="string">&#x27;canary-10&#x27;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo &quot;Phase 1: Route 10% traffic to new version&quot;</span></span><br><span class="line"><span class="string">          aws lambda update-alias \</span></span><br><span class="line"><span class="string">            --function-name $&#123;&#123; inputs.function_name &#125;&#125; \</span></span><br><span class="line"><span class="string">            --name production \</span></span><br><span class="line"><span class="string">            --function-version $&#123;&#123; needs.validate.outputs.current_version &#125;&#125; \</span></span><br><span class="line"><span class="string">            --routing-config &quot;&#123;\&quot;AdditionalVersionWeights\&quot;: &#123;\&quot;$&#123;&#123; inputs.version &#125;&#125;\&quot;: 0.1&#125;&#125;&quot;</span></span><br><span class="line"><span class="string"></span>          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Monitoring for 10 minutes...&quot;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">600</span></span><br><span class="line">          </span><br><span class="line">          <span class="comment"># メトリクスをチェック</span></span><br><span class="line">          <span class="string">ERROR_RATE=$(aws</span> <span class="string">cloudwatch</span> <span class="string">get-metric-statistics</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--namespace</span> <span class="string">AWS/Lambda</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--metric-name</span> <span class="string">Errors</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--dimensions</span> <span class="string">Name=FunctionName,Value=$&#123;&#123;</span> <span class="string">inputs.function_name</span> <span class="string">&#125;&#125;</span> <span class="string">Name=Resource,Value=$&#123;&#123;</span> <span class="string">inputs.function_name</span> <span class="string">&#125;&#125;:production</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--start-time</span> <span class="string">$(date</span> <span class="string">-u</span> <span class="string">-d</span> <span class="string">&#x27;10 minutes ago&#x27;</span> <span class="string">+%Y-%m-%dT%H:%M:%S)</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--end-time</span> <span class="string">$(date</span> <span class="string">-u</span> <span class="string">+%Y-%m-%dT%H:%M:%S)</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--period</span> <span class="number">600</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--statistics</span> <span class="string">Sum</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--query</span> <span class="string">&#x27;Datapoints[0].Sum&#x27;</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--output</span> <span class="string">text)</span></span><br><span class="line">          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Error count in last 10 minutes: $ERROR_RATE&quot;</span></span><br><span class="line">          </span><br><span class="line">          <span class="string">if</span> [ <span class="string">&quot;$ERROR_RATE&quot;</span> <span class="type">!=</span> <span class="string">&quot;None&quot;</span> ] <span class="string">&amp;&amp;</span> [ <span class="string">&quot;$ERROR_RATE&quot;</span> <span class="string">-gt</span> <span class="number">10</span> ]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;❌ Error rate too high! Rolling back...&quot;</span></span><br><span class="line">            <span class="string">aws</span> <span class="string">lambda</span> <span class="string">update-alias</span> <span class="string">\</span></span><br><span class="line">              <span class="string">--function-name</span> <span class="string">$&#123;&#123;</span> <span class="string">inputs.function_name</span> <span class="string">&#125;&#125;</span> <span class="string">\</span></span><br><span class="line">              <span class="string">--name</span> <span class="string">production</span> <span class="string">\</span></span><br><span class="line">              <span class="string">--function-version</span> <span class="string">$&#123;&#123;</span> <span class="string">needs.validate.outputs.current_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">            <span class="string">exit</span> <span class="number">1</span></span><br><span class="line">          <span class="string">fi</span></span><br><span class="line">          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;Phase 2: Route 100% traffic to new version&quot;</span></span><br><span class="line">          <span class="string">aws</span> <span class="string">lambda</span> <span class="string">update-alias</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--function-name</span> <span class="string">$&#123;&#123;</span> <span class="string">inputs.function_name</span> <span class="string">&#125;&#125;</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--name</span> <span class="string">production</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--function-version</span> <span class="string">$&#123;&#123;</span> <span class="string">inputs.version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          </span><br><span class="line">          <span class="string">echo</span> <span class="string">&quot;✅ Canary release completed successfully&quot;</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Verify</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          CURRENT=$(aws lambda get-alias \</span></span><br><span class="line"><span class="string">            --function-name $&#123;&#123; inputs.function_name &#125;&#125; \</span></span><br><span class="line"><span class="string">            --name production \</span></span><br><span class="line"><span class="string">            --query &#x27;FunctionVersion&#x27; \</span></span><br><span class="line"><span class="string">            --output text)</span></span><br><span class="line"><span class="string"></span>          </span><br><span class="line">          <span class="string">if</span> [ <span class="string">&quot;$CURRENT&quot;</span> <span class="string">==</span> <span class="string">&quot;$<span class="template-variable">&#123;&#123; inputs.version &#125;&#125;</span>&quot;</span> ]<span class="string">;</span> <span class="string">then</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;✅ Production is now running version $<span class="template-variable">&#123;&#123; inputs.version &#125;&#125;</span>&quot;</span></span><br><span class="line">          <span class="string">else</span></span><br><span class="line">            <span class="string">echo</span> <span class="string">&quot;❌ Verification failed - production version is $CURRENT&quot;</span></span><br><span class="line">            <span class="string">exit</span> <span class="number">1</span></span><br><span class="line">          <span class="string">fi</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Notify</span> <span class="string">Slack</span></span><br><span class="line">        <span class="attr">if:</span> <span class="string">always()</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">slackapi/slack-github-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">webhook-url:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SLACK_WEBHOOK_URL</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">payload:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              &quot;text&quot;: &quot;$&#123;&#123; job.status == &#x27;success&#x27; &amp;&amp; &#x27;✅&#x27; || &#x27;❌&#x27; &#125;&#125; Production Release&quot;,</span></span><br><span class="line"><span class="string">              &quot;blocks&quot;: [</span></span><br><span class="line"><span class="string">                &#123;</span></span><br><span class="line"><span class="string">                  &quot;type&quot;: &quot;section&quot;,</span></span><br><span class="line"><span class="string">                  &quot;text&quot;: &#123;</span></span><br><span class="line"><span class="string">                    &quot;type&quot;: &quot;mrkdwn&quot;,</span></span><br><span class="line"><span class="string">                    &quot;text&quot;: &quot;*Production Release $&#123;&#123; job.status &#125;&#125;*\n\n*Function:* $&#123;&#123; inputs.function_name &#125;&#125;\n*Version:* $&#123;&#123; inputs.version &#125;&#125;\n*Previous:* $&#123;&#123; needs.validate.outputs.current_version &#125;&#125;\n*Strategy:* $&#123;&#123; inputs.strategy &#125;&#125;\n*Approved by:* $&#123;&#123; github.actor &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">                  &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              ]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="変更検知とパス指定"><a href="#変更検知とパス指定" class="headerlink" title="変更検知とパス指定"></a>変更検知とパス指定</h3><h4 id="効率的なデプロイ"><a href="#効率的なデプロイ" class="headerlink" title="効率的なデプロイ"></a>効率的なデプロイ</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 変更されたファイルに応じてジョブを実行</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [<span class="string">main</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">detect-changes:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">outputs:</span></span><br><span class="line">      <span class="attr">functions:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.filter.outputs.functions</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">layers:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.filter.outputs.layers</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.filter.outputs.template</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v4</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">dorny/paths-filter@v2</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">filter</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">filters:</span> <span class="string">|</span></span><br><span class="line"><span class="string">            functions:</span></span><br><span class="line"><span class="string">              - &#x27;functions/**&#x27;</span></span><br><span class="line"><span class="string">            layers:</span></span><br><span class="line"><span class="string">              - &#x27;layers/**&#x27;</span></span><br><span class="line"><span class="string">            template:</span></span><br><span class="line"><span class="string">              - &#x27;template.yaml&#x27;</span></span><br><span class="line"><span class="string">              - &#x27;samconfig.toml&#x27;</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">detect-changes</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      needs.detect-changes.outputs.functions == &#x27;true&#x27; ||</span></span><br><span class="line"><span class="string">      needs.detect-changes.outputs.layers == &#x27;true&#x27; ||</span></span><br><span class="line"><span class="string">      needs.detect-changes.outputs.template == &#x27;true&#x27;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># デプロイ処理</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="命名規則とタグ戦略"><a href="#命名規則とタグ戦略" class="headerlink" title="命名規則とタグ戦略"></a>命名規則とタグ戦略</h2><h3 id="リソース命名規則"><a href="#リソース命名規則" class="headerlink" title="リソース命名規則"></a>リソース命名規則</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">基本パターン:</span></span><br><span class="line">&#123;<span class="string">project</span>&#125;<span class="string">-&#123;resource-type&#125;-&#123;environment&#125;-&#123;purpose&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">例:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">myapp-lambda-prod-user-auth</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">myapp-rds-prod-main</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">myapp-s3-prod-data</span></span><br><span class="line"></span><br><span class="line"><span class="string">Lambda関数:</span></span><br><span class="line">&#123;<span class="string">purpose</span>&#125;<span class="string">-function</span></span><br><span class="line"></span><br><span class="line"><span class="string">例:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">user-login-function</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">create-order-function</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">process-payment-function</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Layer:</span></span><br><span class="line">&#123;<span class="string">purpose</span>&#125;<span class="string">-layer</span></span><br><span class="line"></span><br><span class="line"><span class="string">例:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">dependencies-layer</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">company-utils-layer</span></span><br><span class="line"></span><br><span class="line"><span class="string">エイリアス:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">development</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">staging</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">production</span></span><br><span class="line"><span class="string">（全て小文字、統一）</span></span><br><span class="line"></span><br><span class="line"><span class="string">SSMパラメータ:</span></span><br><span class="line"><span class="string">/shared/&#123;service&#125;/&#123;resource-type&#125;/&#123;name&#125;</span></span><br><span class="line"><span class="string">/apps/&#123;function-name&#125;/&#123;key&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="タグ戦略"><a href="#タグ戦略" class="headerlink" title="タグ戦略"></a>タグ戦略</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 全リソース共通タグ</span><br><span class="line">locals &#123;</span><br><span class="line">  common_tags = &#123;</span><br><span class="line">    Project     = var.project_name</span><br><span class="line">    Environment = var.environment</span><br><span class="line">    ManagedBy   = &quot;Terraform&quot;  # or &quot;SAM&quot;</span><br><span class="line">    Team        = var.team_name</span><br><span class="line">    CostCenter  = var.cost_center</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># リソース固有タグ</span><br><span class="line">resource &quot;aws_lambda_function&quot; &quot;example&quot; &#123;</span><br><span class="line">  tags = merge(</span><br><span class="line">    local.common_tags,</span><br><span class="line">    &#123;</span><br><span class="line">      Purpose = &quot;UserAuthentication&quot;</span><br><span class="line">      Runtime = &quot;Python3.11&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="セキュリティ考慮事項"><a href="#セキュリティ考慮事項" class="headerlink" title="セキュリティ考慮事項"></a>セキュリティ考慮事項</h2><h3 id="OIDC認証の設定"><a href="#OIDC認証の設定" class="headerlink" title="OIDC認証の設定"></a>OIDC認証の設定</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GitHub ActionsからAWSへの認証</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Terraform側</span></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;aws_iam_openid_connect_provider&quot;</span> <span class="string">&quot;github&quot;</span> &#123;</span><br><span class="line">  <span class="string">url</span> <span class="string">=</span> <span class="string">&quot;https://token.actions.githubusercontent.com&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">client_id_list</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;sts.amazonaws.com&quot;</span></span><br><span class="line">  ]</span><br><span class="line">  </span><br><span class="line">  <span class="string">thumbprint_list</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;6938fd4d98bab03faadb97b34396831e3780aea1&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">resource</span> <span class="string">&quot;aws_iam_role&quot;</span> <span class="string">&quot;github_actions&quot;</span> &#123;</span><br><span class="line">  <span class="string">name</span> <span class="string">=</span> <span class="string">&quot;github-actions-lambda-deploy&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">assume_role_policy</span> <span class="string">=</span> <span class="string">jsonencode(</span>&#123;</span><br><span class="line">    <span class="string">Version</span> <span class="string">=</span> <span class="string">&quot;2012-10-17&quot;</span></span><br><span class="line">    <span class="string">Statement</span> <span class="string">=</span> [&#123;</span><br><span class="line">      <span class="string">Effect</span> <span class="string">=</span> <span class="string">&quot;Allow&quot;</span></span><br><span class="line">      <span class="string">Principal</span> <span class="string">=</span> &#123;</span><br><span class="line">        <span class="string">Federated</span> <span class="string">=</span> <span class="string">aws_iam_openid_connect_provider.github.arn</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="string">Action</span> <span class="string">=</span> <span class="string">&quot;sts:AssumeRoleWithWebIdentity&quot;</span></span><br><span class="line">      <span class="string">Condition</span> <span class="string">=</span> &#123;</span><br><span class="line">        <span class="string">StringEquals</span> <span class="string">=</span> &#123;</span><br><span class="line">          <span class="string">&quot;token.actions.githubusercontent.com:aud&quot;</span> <span class="string">=</span> <span class="string">&quot;sts.amazonaws.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="string">StringLike</span> <span class="string">=</span> &#123;</span><br><span class="line">          <span class="string">&quot;token.actions.githubusercontent.com:sub&quot;</span> <span class="string">=</span> <span class="string">&quot;repo:your-org/lambda-applications:*&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;<span class="string">)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># GitHub Actions側</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">aws-actions/configure-aws-credentials@v4</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">role-to-assume:</span> <span class="string">arn:aws:iam::123456789012:role/github-actions-lambda-deploy</span></span><br><span class="line">    <span class="attr">aws-region:</span> <span class="string">ap-northeast-1</span></span><br></pre></td></tr></table></figure>

<h3 id="シークレット管理"><a href="#シークレット管理" class="headerlink" title="シークレット管理"></a>シークレット管理</h3><p>推奨:</p>
<ol>
<li><p>GitHub Secrets:</p>
<ul>
<li>AWS Role ARN</li>
<li>Slack Webhook URL</li>
</ul>
</li>
<li><p>AWS Secrets Manager:</p>
<ul>
<li>データベースパスワード</li>
<li>API Key</li>
<li>OAuth Token</li>
</ul>
</li>
<li><p>SSM Parameter Store (SecureString):</p>
<ul>
<li>設定値（機密）</li>
<li>証明書</li>
</ul>
</li>
</ol>
<p>非推奨:<br>❌ コードに直接埋め込み<br>❌ 環境変数に平文<br>❌ Gitにコミット</p>
<hr>
<h2 id="監視とロギング"><a href="#監視とロギング" class="headerlink" title="監視とロギング"></a>監視とロギング</h2><h3 id="CloudWatch設定"><a href="#CloudWatch設定" class="headerlink" title="CloudWatch設定"></a>CloudWatch設定</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SAM</span></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">MyFunction:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Serverless::Function</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="comment"># ログ設定</span></span><br><span class="line">      <span class="attr">LoggingConfig:</span></span><br><span class="line">        <span class="attr">LogFormat:</span> <span class="string">JSON</span></span><br><span class="line">        <span class="attr">LogGroup:</span> <span class="type">!Ref</span> <span class="string">MyFunctionLogGroup</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment"># トレーシング</span></span><br><span class="line">      <span class="attr">Tracing:</span> <span class="string">Active</span>  <span class="comment"># X-Ray有効化</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">MyFunctionLogGroup:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::Logs::LogGroup</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">LogGroupName:</span> <span class="type">!Sub</span> <span class="string">&#x27;/aws/lambda/$&#123;MyFunction&#125;&#x27;</span></span><br><span class="line">      <span class="attr">RetentionInDays:</span> <span class="number">7</span>  <span class="comment"># staging: 7日、production: 30日</span></span><br></pre></td></tr></table></figure>

<h3 id="アラーム設定"><a href="#アラーム設定" class="headerlink" title="アラーム設定"></a>アラーム設定</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># Terraform</span><br><span class="line">resource &quot;aws_cloudwatch_metric_alarm&quot; &quot;lambda_errors&quot; &#123;</span><br><span class="line">  alarm_name          = &quot;$&#123;var.function_name&#125;-errors&quot;</span><br><span class="line">  comparison_operator = &quot;GreaterThanThreshold&quot;</span><br><span class="line">  evaluation_periods  = 2</span><br><span class="line">  metric_name         = &quot;Errors&quot;</span><br><span class="line">  namespace           = &quot;AWS/Lambda&quot;</span><br><span class="line">  period              = 60</span><br><span class="line">  statistic           = &quot;Sum&quot;</span><br><span class="line">  threshold           = 10</span><br><span class="line">  alarm_description   = &quot;Lambda function error rate&quot;</span><br><span class="line">  </span><br><span class="line">  dimensions = &#123;</span><br><span class="line">    FunctionName = var.function_name</span><br><span class="line">    Resource     = &quot;$&#123;var.function_name&#125;:production&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  alarm_actions = [aws_sns_topic.alerts.arn]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="次のステップ"><a href="#次のステップ" class="headerlink" title="次のステップ"></a>次のステップ</h2><p>実装のガイドラインを理解したら、メリット・デメリットを確認します。</p>
<p>👉 <a href="/2025/11/02/lambda-cicd-04-tradeoffs/" title="Lambda CI&#x2F;CD アーキテクチャ - 4. メリット・デメリット">次へ: 4. メリットとデメリットとして認識すべきこと</a></p>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/AWS-Lambda/">AWS Lambda</a><a class="link-muted mr-2" rel="tag" href="/tags/CI-CD/">CI/CD</a><a class="link-muted mr-2" rel="tag" href="/tags/Terraform/">Terraform</a><a class="link-muted mr-2" rel="tag" href="/tags/SAM/">SAM</a><a class="link-muted mr-2" rel="tag" href="/tags/GitHub-Actions/">GitHub Actions</a><a class="link-muted mr-2" rel="tag" href="/tags/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/">アーキテクチャ</a><a class="link-muted mr-2" rel="tag" href="/tags/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9/">インフラ</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2025/11/02/lambda-cicd-04-tradeoffs/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Lambda CI/CD アーキテクチャ - 4. メリット・デメリット</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/11/02/lambda-cicd-02-components/"><span class="level-item">Lambda CI/CD アーキテクチャ - 2. 構成要素と役割</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/images/iam.png" alt="たまむー"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">たまむー</p><p class="is-size-6 is-block">Cloud Architect</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>ap-northeast-3</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">投稿</p><a href="/archives/"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">カテゴリ</p><a href="/categories/"><p class="title">9</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">タグ</p><a href="/tags/"><p class="title">20</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Homepage" href="https://tamamu.cc"><i class="fa-solid fa-house"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">カタログ</h3><ul class="menu-list"><li><a class="level is-mobile" href="#ドキュメント構成"><span class="level-left"><span class="level-item">1</span><span class="level-item">ドキュメント構成</span></span></a></li><li><a class="level is-mobile" href="#目次"><span class="level-left"><span class="level-item">2</span><span class="level-item">目次</span></span></a></li><li><a class="level is-mobile" href="#Terraform実装ガイドライン"><span class="level-left"><span class="level-item">3</span><span class="level-item">Terraform実装ガイドライン</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#IAMロール・ポリシー管理"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">IAMロール・ポリシー管理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#基本方針"><span class="level-left"><span class="level-item">3.1.1</span><span class="level-item">基本方針</span></span></a></li><li><a class="level is-mobile" href="#Lambda実行ロールの実装"><span class="level-left"><span class="level-item">3.1.2</span><span class="level-item">Lambda実行ロールの実装</span></span></a></li><li><a class="level is-mobile" href="#留意点"><span class="level-left"><span class="level-item">3.1.3</span><span class="level-item">留意点</span></span></a></li></ul></li><li><a class="level is-mobile" href="#VPC・ネットワーク設定"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">VPC・ネットワーク設定</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#基本構成"><span class="level-left"><span class="level-item">3.2.1</span><span class="level-item">基本構成</span></span></a></li><li><a class="level is-mobile" href="#留意点-1"><span class="level-left"><span class="level-item">3.2.2</span><span class="level-item">留意点</span></span></a></li></ul></li><li><a class="level is-mobile" href="#SSM-Parameter-Store活用"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">SSM Parameter Store活用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#命名規則"><span class="level-left"><span class="level-item">3.3.1</span><span class="level-item">命名規則</span></span></a></li><li><a class="level is-mobile" href="#実装パターン"><span class="level-left"><span class="level-item">3.3.2</span><span class="level-item">実装パターン</span></span></a></li><li><a class="level is-mobile" href="#留意点-2"><span class="level-left"><span class="level-item">3.3.3</span><span class="level-item">留意点</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#SAM実装ガイドライン"><span class="level-left"><span class="level-item">4</span><span class="level-item">SAM実装ガイドライン</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Lambda関数構成"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">Lambda関数構成</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#ディレクトリ構造"><span class="level-left"><span class="level-item">4.1.1</span><span class="level-item">ディレクトリ構造</span></span></a></li><li><a class="level is-mobile" href="#関数実装のベストプラクティス"><span class="level-left"><span class="level-item">4.1.2</span><span class="level-item">関数実装のベストプラクティス</span></span></a></li><li><a class="level is-mobile" href="#留意点-3"><span class="level-left"><span class="level-item">4.1.3</span><span class="level-item">留意点</span></span></a></li></ul></li><li><a class="level is-mobile" href="#Layer管理"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">Layer管理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Layer構造"><span class="level-left"><span class="level-item">4.2.1</span><span class="level-item">Layer構造</span></span></a></li><li><a class="level is-mobile" href="#SAMテンプレート"><span class="level-left"><span class="level-item">4.2.2</span><span class="level-item">SAMテンプレート</span></span></a></li><li><a class="level is-mobile" href="#留意点-4"><span class="level-left"><span class="level-item">4.2.3</span><span class="level-item">留意点</span></span></a></li></ul></li><li><a class="level is-mobile" href="#エイリアス設定"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">エイリアス設定</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#実装パターン-1"><span class="level-left"><span class="level-item">4.3.1</span><span class="level-item">実装パターン</span></span></a></li><li><a class="level is-mobile" href="#留意点-5"><span class="level-left"><span class="level-item">4.3.2</span><span class="level-item">留意点</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#GitHub-Actions実装ガイドライン"><span class="level-left"><span class="level-item">5</span><span class="level-item">GitHub Actions実装ガイドライン</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#デプロイワークフロー"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">デプロイワークフロー</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#Staging自動デプロイ"><span class="level-left"><span class="level-item">5.1.1</span><span class="level-item">Staging自動デプロイ</span></span></a></li><li><a class="level is-mobile" href="#Production手動リリース"><span class="level-left"><span class="level-item">5.1.2</span><span class="level-item">Production手動リリース</span></span></a></li></ul></li><li><a class="level is-mobile" href="#変更検知とパス指定"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">変更検知とパス指定</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#効率的なデプロイ"><span class="level-left"><span class="level-item">5.2.1</span><span class="level-item">効率的なデプロイ</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#命名規則とタグ戦略"><span class="level-left"><span class="level-item">6</span><span class="level-item">命名規則とタグ戦略</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#リソース命名規則"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">リソース命名規則</span></span></a></li><li><a class="level is-mobile" href="#タグ戦略"><span class="level-left"><span class="level-item">6.2</span><span class="level-item">タグ戦略</span></span></a></li></ul></li><li><a class="level is-mobile" href="#セキュリティ考慮事項"><span class="level-left"><span class="level-item">7</span><span class="level-item">セキュリティ考慮事項</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#OIDC認証の設定"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">OIDC認証の設定</span></span></a></li><li><a class="level is-mobile" href="#シークレット管理"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">シークレット管理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#監視とロギング"><span class="level-left"><span class="level-item">8</span><span class="level-item">監視とロギング</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#CloudWatch設定"><span class="level-left"><span class="level-item">8.1</span><span class="level-item">CloudWatch設定</span></span></a></li><li><a class="level is-mobile" href="#アラーム設定"><span class="level-left"><span class="level-item">8.2</span><span class="level-item">アラーム設定</span></span></a></li></ul></li><li><a class="level is-mobile" href="#次のステップ"><span class="level-left"><span class="level-item">9</span><span class="level-item">次のステップ</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">タグ</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AWS-Lambda/"><span class="tag">AWS Lambda</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bedrock/"><span class="tag">Bedrock</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CI-CD/"><span class="tag">CI/CD</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/DNS/"><span class="tag">DNS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GitHub-Actions/"><span class="tag">GitHub Actions</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Node-js/"><span class="tag">Node.js</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Python/"><span class="tag">Python</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Route53/"><span class="tag">Route53</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SAM/"><span class="tag">SAM</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Slack/"><span class="tag">Slack</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Terraform/"><span class="tag">Terraform</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Zed/"><span class="tag">Zed</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bash/"><span class="tag">bash</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mise/"><span class="tag">mise</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sshd/"><span class="tag">sshd</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/uv/"><span class="tag">uv</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/zsh/"><span class="tag">zsh</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3/"><span class="tag">アーキテクチャ</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9/"><span class="tag">インフラ</span><span class="tag">5</span></a></div></div></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">カテゴリ</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AWS/"><span class="level-start"><span class="level-item">AWS</span></span><span class="level-end"><span class="level-item tag">5</span></span></a><ul><li><a class="level is-mobile" href="/categories/AWS/DevOps/"><span class="level-start"><span class="level-item">DevOps</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/DNS/"><span class="level-start"><span class="level-item">DNS</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Mac/"><span class="level-start"><span class="level-item">Mac</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Node-js/"><span class="level-start"><span class="level-item">Node.js</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Python/"><span class="level-start"><span class="level-item">Python</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Slack/"><span class="level-start"><span class="level-item">Slack</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Zed/"><span class="level-start"><span class="level-item">Zed</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最近の記事</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-11-02T13:04:00.000Z">2025-11-02</time></p><p class="title"><a href="/2025/11/02/lambda-cicd-04-tradeoffs/">Lambda CI/CD アーキテクチャ - 4. メリット・デメリット</a></p><p class="categories"><a href="/categories/AWS/">AWS</a> / <a href="/categories/AWS/DevOps/">DevOps</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-11-02T13:03:00.000Z">2025-11-02</time></p><p class="title"><a href="/2025/11/02/lambda-cicd-03-implementation/">Lambda CI/CD アーキテクチャ - 3. 実装ガイドライン</a></p><p class="categories"><a href="/categories/AWS/">AWS</a> / <a href="/categories/AWS/DevOps/">DevOps</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-11-02T13:02:00.000Z">2025-11-02</time></p><p class="title"><a href="/2025/11/02/lambda-cicd-02-components/">Lambda CI/CD アーキテクチャ - 2. 構成要素と役割</a></p><p class="categories"><a href="/categories/AWS/">AWS</a> / <a href="/categories/AWS/DevOps/">DevOps</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-11-02T13:01:00.000Z">2025-11-02</time></p><p class="title"><a href="/2025/11/02/lambda-cicd-01-principles/">Lambda CI/CD アーキテクチャ - 1. 環境構築における方針</a></p><p class="categories"><a href="/categories/AWS/">AWS</a> / <a href="/categories/AWS/DevOps/">DevOps</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2025-11-02T13:00:00.000Z">2025-11-02</time></p><p class="title"><a href="/2025/11/02/lambda-cicd-00-index/">Lambda CI/CD アーキテクチャ設計書 - 目次</a></p><p class="categories"><a href="/categories/AWS/">AWS</a> / <a href="/categories/AWS/DevOps/">DevOps</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">アーカイブ</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2025/11/"><span class="level-start"><span class="level-item">11月 2025</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2025/06/"><span class="level-start"><span class="level-item">6月 2025</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/09/"><span class="level-start"><span class="level-item">9月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">Tamamu blog</a><p class="is-size-7"><span>&copy; 2025 ktamamu</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("ja");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="トップに戻る" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="何かを入力してください..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script data-pjax src="/js/insight.js" defer></script><script data-pjax>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"何かを入力してください...","untitled":"(無題)","posts":"投稿","pages":"ページ","categories":"カテゴリ","tags":"タグ"});
        });</script></body></html>